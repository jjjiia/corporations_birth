(function(b){function l(c,e){var j=c[0]-e[0],g=c[1]-e[1];return j*j+g*g}function q(c){for(var e=0,j=0,g=0,b=c.length-3;g<b;g+=2)e+=c[g],j+=c[g+1];c=2*(c.length-2);return[e/c<<0,j/c<<0]}function T(c){var e=c.length/2,j=new Z(e),g=0,b=e-1,m,f,k,D,l=[],q=[],I=[];for(j[g]=j[b]=1;b;){f=0;for(m=g+1;m<b;m++){k=c[2*m];var J=c[2*m+1],A=c[2*g],B=c[2*g+1],C=c[2*b],F=c[2*b+1],r=C-A,E=F-B,y=void 0;if(0!==r||0!==E)y=((k-A)*r+(J-B)*E)/(r*r+E*E),1<y?(A=C,B=F):0<y&&(A+=r*y,B+=E*y);r=k-A;E=J-B;k=r*r+E*E;k>f&&(D=m,
f=k)}2<f&&(j[D]=1,l.push(g),q.push(D),l.push(D),q.push(b));g=l.pop();b=q.pop()}for(m=0;m<e;m++)j[m]&&I.push(c[2*m],c[2*m+1]);return I}var Ba=Ba||Array,Z=Z||Array,f=Math,Ka=f.exp,La=f.log,Ma=f.sin,Na=f.cos,va=f.tan,Oa=f.atan,aa=f.min,wa=f.max,pa=document,k,Ca=function(c){var e,j,g;if(0===c.s)e=j=g=c.l;else{g=0.5>c.l?c.l*(1+c.s):c.l+c.s-c.l*c.s;var b=2*c.l-g;c.h/=360;e=V(b,g,c.h+1/3);j=V(b,g,c.h);g=V(b,g,c.h-1/3)}return new k(255*e<<0,255*j<<0,255*g<<0,c.a)},V=function(c,e,j){0>j&&(j+=1);1<j&&(j-=1);
return j<1/6?c+6*(e-c)*j:0.5>j?e:j<2/3?c+6*(e-c)*(2/3-j):c},f=function(c,e,j,b){this.r=c;this.g=e;this.b=j;this.a=4>arguments.length?1:b},W=f.prototype;W.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join()+")"};W.adjustLightness=function(c){var e=k.toHSLA(this);e.l*=c;e.l=Math.min(1,Math.max(0,e.l));return Ca(e)};W.adjustAlpha=function(c){return new k(this.r,this.g,this.b,this.a*c)};f.parse=function(c){var e;c+="";if(~c.indexOf("#"))return e=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/),
new k(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1);if(e=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new k(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5]):1);if(e=c.match(/hsla?\(([\d.]+)\D+([\d.]+)\D+([\d.]+)(\D+([\d.]+))?\)/))return Ca({h:parseInt(e[1],10),s:parseFloat(e[2]),l:parseFloat(e[3]),a:e[4]?parseFloat(e[5]):1})};f.toHSLA=function(c){var e=c.r/255,b=c.g/255,g=c.b/255,f=Math.max(e,b,g),m=Math.min(e,b,g),
k,D=(f+m)/2,l;if(f===m)k=m=0;else{l=f-m;m=0.5<D?l/(2-f-m):l/(f+m);switch(f){case e:k=(b-g)/l+(b<g?6:0);break;case b:k=(g-e)/l+2;break;case g:k=(e-b)/l+4}k/=6}return{h:360*k,s:m,l:D,a:c.a}};k=f;var Da,f=Math,H=f.sin,K=f.cos,Pa=f.tan,Ea=f.asin,Fa=f.atan2,R=f.PI,C=180/R,Qa=357.5291/C,Ra=0.98560028/C,Sa=1.9148/C,Ta=0.02/C,Ua=3E-4/C,Va=102.9372/C,Ga=23.45/C,Wa=280.16/C,Xa=360.9856235/C;Da=function(c,e,b){b=-b/C;e/=C;c=c.valueOf()/864E5-0.5+2440588;var g=Qa+Ra*(c-2451545),f=Sa*H(g)+Ta*H(2*g)+Ua*H(3*g),
f=g+Va+f+R,g=Ea(H(f)*H(Ga)),f=Fa(H(f)*K(Ga),K(f));b=Wa+Xa*(c-2451545)-b-f;return{altitude:Ea(H(e)*H(g)+K(e)*K(g)*K(b)),azimuth:Fa(H(b),K(b)*H(e)-Pa(g)*K(e))-R/2}};var ba=Math.PI,Ha=ba/2,Ya=ba/4,Za=180/ba,$a=256,xa=14,ca="latitude",da="longitude",Ia=3,Ja=4,I=0,D=1,J=2,F=3,qa=4,S=5,N=6;b.OSMBuildings=function(c){function e(a,n){var d={};a/=ea;n/=ea;d[ca]=0>=n?90:1<=n?-90:Za*(2*Oa(Ka(ba*(1-2*n)))-Ha);d[da]=360*(1===a?1:(a%1+1)%1)-180;return d}function f(){if(R&&!(y<xa)){var a=e(r-U,E-oa),n=e(r+A+U,E+
B+oa);ra&&ra.abort();var d={w:a[da],n:a[ca],e:n[da],s:n[ca],z:y},a=R.replace(/\{ *([\w_]+) *\}/g,function(a,n){return d[n]}),h=g,p=new XMLHttpRequest;p.onreadystatechange=function(){4===p.readyState&&p.status&&!(200>p.status||299<p.status)&&p.responseText&&h(JSON.parse(p.responseText))};p.open("GET",a);p.send(null);ra=p}}function g(a){var n,d,h,p,c=[],e=d=0;X=xa;K(y);ra=null;if(a&&a.meta.z===y){p=a.meta;h=a.data;if(z&&s&&z.z===p.z){d=z.x-p.x;e=z.y-p.y;a=0;for(n=s.length;a<n;a++)c[a]=s[a][J][0]+d+
","+(s[a][J][1]+e)}z=p;s=[];a=0;for(n=h.length;a<n;a++)if(p=[],!(h[a][D]>fa)&&(d=T(h[a][J]),!(8>d.length))){p[J]=d;p[qa]=q(d);p[I]=aa(h[a][I],fa);p[D]=h[a][D];d=p[J][0]+","+p[J][1];p[S]=!(c&&~c.indexOf(d));p[F]=[];p[N]=[];d=h[a][Ia]?k.parse(h[a][Ia]):null;e=h[a][Ja]?k.parse(h[a][Ja]):null;p[F]=[d||null,d?d.adjustLightness(0.8):null,e?e:d?d.adjustLightness(1.2):P];for(d=0;3>d;d++)p[F][d]&&(p[N][d]=p[F][d].adjustAlpha(L)+"");s.push(p)}V()}}function C(a,n){var d,h,p=[],c,e,b,w,f,g,j,k,l=ya-y;c=0;for(e=
a.length;c<e;c++)if(f=a[c],j=f[D]>>l,!(j>fa)){g=f[J];k=new Ba(g.length);b=0;for(w=g.length-1;b<w;b+=2)d=g[b+1],h=aa(1,wa(0,0.5-La(va(Ya+Ha*g[b]/180))/ba/2)),d=(d/360+0.5)*ea<<0,h=h*ea<<0,k[b]=d,k[b+1]=h;k=T(k);if(!(8>k.length)){w=[];w[J]=k;w[qa]=q(k);w[I]=aa(f[I]>>l,fa);w[D]=j;w[S]=n;w[F]=f[F];w[N]=[];for(b=0;3>b;b++)w[F][b]&&(w[N][b]=w[F][b].adjustAlpha(L)+"");p.push(w)}}return p}function m(a,n,d){void 0===d&&(d=[]);var h,b,c,e=a[0]?a:a.features,f,w,g,j,l,s,B=n?1:0,v=n?0:1;if(e){a=0;for(h=e.length;a<
h;a++)m(e[a],n,d);return d}"Feature"===a.type&&(h=a.geometry,w=a.properties);"Polygon"===h.type&&(f=[h.coordinates]);"MultiPolygon"===h.type&&(f=h.coordinates);if(f){j=w.height;if(w.color||w.wallColor)l=k.parse(w.color||w.wallColor);w.roofColor&&(s=k.parse(w.roofColor));a=0;for(h=f.length;a<h;a++){n=f[a][0];g=[];b=e=0;for(c=n.length;b<c;b++)g.push(n[b][B],n[b][v]),e+=j||n[b][2]||0;if(e){c=b=[];var u=J;for(var t=void 0,x=void 0,z=void 0,A=void 0,y=0,r=void 0,E=void 0,r=0,E=g.length-3;r<E;r+=2)t=g[r],
x=g[r+1],z=g[r+2],A=g[r+3],y+=t*A-z*x;if("CW"!==(0<y/2?"CW":"CCW")){t=[];for(x=g.length-2;0<=x;x-=2)t.push(g[x],g[x+1]);g=t}c[u]=g;b[I]=e/n.length<<0;b[D]=w.minHeight;b[F]=[l||null,l?l.adjustLightness(0.8):null,s?s:l?l.adjustLightness(1.2):P];d.push(b)}}}return d}function H(a,n){a?(ga=m(a,n),X=0,K(y),z={n:90,w:-180,s:-90,e:180,x:0,y:0,z:y},s=C(ga,!0),V()):(ga=null,$())}function K(a){var n,d,h;y=a;ea=$a<<y;a=y;n=X;d=ya;a=aa(wa(a,n),d);L=1-aa(wa(0+0.4*((a-n)/(d-n)),0),0.4);za=Q.adjustAlpha(L)+"";ha=
sa.adjustAlpha(L)+"";ia=P.adjustAlpha(L)+"";if(s){a=0;for(n=s.length;a<n;a++){h=s[a];h[N]=[];for(d=0;3>d;d++)h[F][d]&&(h[N][d]=h[F][d].adjustAlpha(L)+"")}}}function V(){clearInterval(Aa);O=0;ta.render();Aa=setInterval(function(){O+=0.1;if(1<O){clearInterval(Aa);O=1;for(var a=0,n=s.length;a<n;a++)s[a][S]=0}ua.render();$()},33)}function ma(){ua.render();ta.render();$()}function $(){M.clearRect(0,0,A,B);if(z&&s&&!(y<X||ja)){var a,n,d,h,b,c,e,g,f,k=r-z.x,j=E-z.y,m=ta.getMaxHeight(),C=[ka+k,la+j],G,v,
u,t,x,q;s.sort(function(a,b){return l(b[qa],C)/b[I]-l(a[qa],C)/a[I]});a=0;for(n=s.length;a<n;a++)if(b=s[a],!(b[I]<=m)){v=!1;c=b[J];G=[];d=0;for(h=c.length-1;d<h;d+=2)G[d]=g=c[d]-k,G[d+1]=f=c[d+1]-j,v||(v=0<g&&g<A&&0<f&&f<B);if(v){d=b[S]?b[I]*O:b[I];c=Y/(Y-d);b[D]&&(d=b[S]?b[D]*O:b[D],e=Y/(Y-d));g=[];d=0;for(h=G.length-3;d<h;d+=2)f=G[d],u=G[d+1],v=G[d+2],t=G[d+3],x=na(f,u,c),q=na(v,t,c),b[D]&&(u=na(f,u,e),t=na(v,t,e),f=u.x,u=u.y,v=t.x,t=t.y),(v-f)*(x.y-u)>(x.x-f)*(t-u)&&(M.fillStyle=f<v&&u<t||f>v&&
u>t?b[N][1]||ha:b[N][0]||za,W([v,t,f,u,x.x,x.y,q.x,q.y])),g[d]=x.x,g[d+1]=x.y;M.fillStyle=b[N][2]||ia;M.strokeStyle=b[N][1]||ha;W(g,!0)}}}}function W(a,b){if(a.length){M.beginPath();M.moveTo(a[0],a[1]);for(var d=2,h=a.length;d<h;d+=2)M.lineTo(a[d],a[d+1]);M.closePath();b&&M.stroke();M.fill()}}function na(a,b,d){return{x:(a-ka)*d+ka<<0,y:(b-la)*d+la<<0}}var A=0,B=0,U=0,oa=0,r=0,E=0,y,ea,ra,M,R,Q=new k(200,190,180),sa=Q.adjustLightness(0.8),P=Q.adjustLightness(1.2),za=Q+"",ha=sa+"",ia=P+"",ga,z,s,O=
1,Aa,L=1,X=xa,ya=20,fa,ka,la,Y,ja,Z={container:null,items:[],init:function(a){var b=this.container=pa.createElement("DIV");b.style.pointerEvents="none";b.style.position="absolute";b.style.left=0;b.style.top=0;ua.init(this.create());ta.init(this.create());M=this.create();a.appendChild(b);return b},create:function(){var a=pa.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=0;a.style.top=0;var b=a.getContext("2d");
b.lineCap="round";b.lineJoin="round";b.lineWidth=1;try{b.mozImageSmoothingEnabled=!1}catch(d){}this.items.push(a);this.container.appendChild(a);return b},setSize:function(a,b){for(var d=this.items,h=0,c=d.length;h<c;h++)d[h].width=a,d[h].height=b}},ua={context:null,color:new k(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=this.context,b,d,h,c;a.clearRect(0,0,A,B);if(z&&
s&&!(y<X||ja))if(b=e(r+U,E+oa),b=Da(this.date,b.latitude,b.longitude),!(0>=b.altitude)){d=1/va(b.altitude);h=0.4/d;this.directionX=Na(b.azimuth)*d;this.directionY=Ma(b.azimuth)*d;this.color.a=h;c=this.color+"";var g,f,k,j,l,m,q=r-z.x,C=E-z.y,G,v,u,t,x,F,H=[];a.beginPath();b=0;for(d=s.length;b<d;b++){f=s[b];v=!1;k=f[J];G=[];h=0;for(g=k.length-1;h<g;h+=2)G[h]=l=k[h]-q,G[h+1]=m=k[h+1]-C,v||(v=0<l&&l<A&&0<m&&m<B);if(v){k=f[S]?f[I]*O:f[I];f[D]&&(j=f[S]?f[D]*O:f[D]);l=null;h=0;for(g=G.length-3;h<g;h+=2)m=
G[h],u=G[h+1],v=G[h+2],t=G[h+3],x=this.project(m,u,k),F=this.project(v,t,k),f[D]&&(u=this.project(m,u,j),t=this.project(v,t,j),m=u.x,u=u.y,v=t.x,t=t.y),(v-m)*(x.y-u)>(x.x-m)*(t-u)?(1===l&&a.lineTo(m,u),l=0,h||a.moveTo(m,u),a.lineTo(v,t)):(0===l&&a.lineTo(x.x,x.y),l=1,h||a.moveTo(x.x,x.y),a.lineTo(F.x,F.y));a.closePath();H.push(G)}}a.fillStyle=c;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();b=0;for(d=H.length;b<d;b++){j=H[b];a.moveTo(j[0],j[1]);h=2;for(g=j.length;h<g;h+=2)a.lineTo(j[h],
j[h+1]);a.lineTo(j[0],j[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}},project:function(a,b,d){return{x:a+this.directionX*d,y:b+this.directionY*d}},setDate:function(a){this.date=a;this.render()}},ta={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,A,B);if(z&&s&&!(y<X||ja)){var b,d,c,e,f,g,j,k=r-z.x,l=E-z.y,m,q;a.beginPath();b=0;for(d=s.length;b<d;b++){c=s[b];q=!1;f=c[J];m=[];c=0;for(e=f.length-
1;c<e;c+=2)m[c]=g=f[c]-k,m[c+1]=j=f[c+1]-l,q||(q=0<g&&g<A&&0<j&&j<B);if(q){c=0;for(e=m.length-3;c<e;c+=2)q=m[c],f=m[c+1],c?a.lineTo(q,f):a.moveTo(q,f);a.closePath()}}a.fillStyle=ia;a.strokeStyle=ha;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=a||{};if(a.color||a.wallColor)Q=k.parse(a.color||a.wallColor),za=Q.adjustAlpha(L)+"",sa=Q.adjustLightness(0.8),ha=sa.adjustAlpha(L)+"",P=Q.adjustLightness(1.2),ia=P.adjustAlpha(L)+"";a.roofColor&&(P=k.parse(a.roofColor),
ia=P.adjustAlpha(L)+"");ma();return this};this.geoJSON=function(a,c){if("object"===typeof a)H(a,!c);else{var d=pa.documentElement,e=pa.createElement("script");b.jsonpCallback=function(a){delete b.jsonpCallback;d.removeChild(e);H(a,!c)};d.insertBefore(e,d.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}return this};this.setCamOffset=function(a,b){ka=U+a;la=B+b};this.setMaxZoom=function(a){ya=a};this.setDate=function(a){ua.setDate(a);return this};this.appendTo=function(a){return Z.init(a)};
this.loadData=f;this.onMoveEnd=function(){var a=e(r,E),b=e(r+A,E+B);ma();z&&(a[ca]>z.n||a[da]<z.w||b[ca]<z.s||b[da]>z.e)&&f()};this.onZoomEnd=function(a){ja=!1;K(a.zoom);ga?(s=C(ga),ma()):($(),f())};this.onZoomStart=function(){ja=!0;ma()};this.setOrigin=function(a,b){r=a;E=b};this.setSize=function(a,b){A=a;B=b;U=A/2<<0;oa=B/2<<0;ka=U;la=B;Y=A/(1.5/(window.devicePixelRatio||1))/va(45)<<0;Z.setSize(A,B);fa=Y-50};this.setZoom=K;this.render=$;R=c};b.OSMBuildings.VERSION="0.1.8a";b.OSMBuildings.ATTRIBUTION=
'&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:!1,alwaysInRange:!0,dxSum:0,dySum:0,initialize:function(b){b=b||{};b.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize.call(this,this.name,b)},setOrigin:function(){var b=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),l=this.map.resolution,q=this.maxExtent,T=Math.round((b.lon-q.left)/l),b=Math.round((q.top-b.lat)/
l);this.osmb.setOrigin(T,b)},setMap:function(b){this.map||OpenLayers.Layer.prototype.setMap.call(this,b);this.osmb||(this.osmb=new OSMBuildings(this.options.url),this.container=this.osmb.appendTo(this.div));this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(b){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap.call(this,b)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize.call(this);
this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},moveTo:function(b,l,q){b=OpenLayers.Layer.prototype.moveTo.call(this,b,l,q);if(!q){q=parseInt(this.map.layerContainerDiv.style.left,10);var T=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-q+"px";this.div.style.top=-T+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);if(l)this.osmb.onZoomEnd({zoom:this.map.zoom});else this.osmb.onMoveEnd();return b},moveByPx:function(b,
l){this.dxSum+=b;this.dySum+=l;var q=OpenLayers.Layer.prototype.moveByPx.call(this,b,l);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return q},geoJSON:function(b,l){return this.osmb.geoJSON(b,l)},setStyle:function(b){return this.osmb.setStyle(b)},setDate:function(b){return this.osmb.setDate(b)}});
